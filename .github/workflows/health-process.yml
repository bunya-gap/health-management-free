name: ğŸ¥ Health Data Processing

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'åˆ†æã‚¿ã‚¤ãƒ—'
        required: false
        default: 'manual'
        type: choice
        options:
        - 'manual'
        - 'full_analysis'
  
  # HAE WebhookçµŒç”±è‡ªå‹•å®Ÿè¡Œ
  repository_dispatch:
    types: [hae_data_received, health_update]
  
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯æ—¥ 8:00, 12:00, 18:00, 22:00 JSTï¼‰
  schedule:
    - cron: '0 23,3,9,13 * * *'  # UTCæ™‚é–“ï¼ˆJST-9æ™‚é–“ï¼‰
  
  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°æ™‚ï¼‰
  push:
    paths:
      - 'health_api_data/*.json'
      - 'reports/*.csv'
      - 'health_processor.py'

jobs:
  health-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
    
    - name: ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      run: |
        mkdir -p health_api_data
        mkdir -p reports
        echo "ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå®Œäº†"
        ls -la
    
    - name: ğŸ” ç’°å¢ƒå¤‰æ•°ç¢ºèª
      run: |
        echo "GitHub Actionsç’°å¢ƒ: $GITHUB_ACTIONS"
        echo "ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥: $GITHUB_EVENT_NAME"
        echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹: $GITHUB_WORKSPACE"
        echo "LINEè¨­å®š: ${{ secrets.LINE_BOT_CHANNEL_ACCESS_TOKEN != '' }}"
        echo "OURAè¨­å®š: ${{ secrets.OURA_ACCESS_TOKEN != '' }}"
        echo "USERè¨­å®š: ${{ secrets.LINE_USER_ID != '' }}"
    
    - name: ğŸ¥ å¥åº·ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Ÿè¡Œ
      env:
        LINE_BOT_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_BOT_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        OURA_ACCESS_TOKEN: ${{ secrets.OURA_ACCESS_TOKEN }}
        GITHUB_ACTIONS: true
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_WORKSPACE: ${{ github.workspace }}
      run: |
        echo "ğŸš€ ä½“çµ„æˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹"
        echo "ğŸ“… å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”„ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: $GITHUB_EVENT_NAME"
        python health_processor.py
        echo "âœ… å¥åº·ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Œäº†"
    
    - name: ğŸ“Š å‡¦ç†çµæœç¢ºèª
      run: |
        echo "ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        ls -la reports/ 2>/dev/null || echo "reportsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
        ls -la health_api_data/ 2>/dev/null || echo "health_api_dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
        
        echo ""
        echo "ğŸ“Š CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª:"
        if [ -f "reports/daily_health_data.csv" ]; then
          wc -l reports/daily_health_data.csv
          echo "âœ… æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿CSVå­˜åœ¨"
        else
          echo "âš ï¸ æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿CSVæœªç”Ÿæˆ"
        fi
        
        if [ -f "reports/health_data_with_ma.csv" ]; then
          wc -l reports/health_data_with_ma.csv
          echo "âœ… ç§»å‹•å¹³å‡ãƒ‡ãƒ¼ã‚¿CSVå­˜åœ¨"
        else
          echo "âš ï¸ ç§»å‹•å¹³å‡ãƒ‡ãƒ¼ã‚¿CSVæœªç”Ÿæˆ"
        fi
    
    - name: ğŸ’¾ çµæœãƒ‡ãƒ¼ã‚¿ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions Health System"
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [[ -n $(git status --porcelain) ]]; then
          echo "ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º - ã‚·ãƒ³ãƒ—ãƒ«ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ"
          
          # æœ€æ–°å–å¾—
          git fetch origin main
          
          # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆhealth_api_dataã¯.gitignoreã§é™¤å¤–ã®ãŸã‚å¯¾è±¡å¤–ï¼‰
          git add reports/
          
          # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
          if git commit -m "ğŸ“Š å¥åº·ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S') [GitHub Actions]"; then
            echo "âœ… ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ"
            
            # ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œï¼ˆç«¶åˆæ™‚ã¯å¼·åˆ¶ï¼‰
            git push origin main || {
              echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•— - å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œ"
              git push origin main --force-with-lease
            }
            echo "âœ… ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ä¿å­˜å®Œäº†"
          else
            echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆå¤±æ•—"
          fi
        else
          echo "ğŸ“­ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
        fi
    
    - name: ğŸ‰ å®Ÿè¡Œå®Œäº†é€šçŸ¥
      run: |
        echo "ğŸŠ ===== GitHub Actions ä½“çµ„æˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œå®Œäº† ====="
        echo "ğŸ“… å®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”„ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: $GITHUB_EVENT_NAME"
        echo "ğŸ’° æœˆé¡è²»ç”¨: Â¥0 (GitHub Actionsç„¡æ–™æ )"
        echo "ğŸ¯ æ¬¡å›å®Ÿè¡Œ: å®šæœŸå®Ÿè¡Œ or æ‰‹å‹•å®Ÿè¡Œ or ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒƒã‚·ãƒ¥"
        echo "âœ… ğŸ˜€ ğ ®· ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"
